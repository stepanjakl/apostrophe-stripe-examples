<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=block"
              rel="stylesheet">

        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/htmx.org@1.x.x"></script>
        <script src="https://unpkg.com/htmx.org@1.x.x/dist/ext/client-side-templates.js"></script>
        <script src="https://unpkg.com/htmx.org@1.x.x/dist/ext/loading-states.js"></script>
        <script src="https://unpkg.com/hyperscript.org@0.x.x"></script>
        <script src="https://unpkg.com/handlebars@4.x.x/dist/handlebars.min.js"></script>
        <script src="https://js.stripe.com/v3/"></script>

        <script defer>
            tailwind.config = {
                theme: {
                    extend: {
                        fontSize: {
                            '2xs': ['0.625rem', '0.875rem'],
                            '3xs': ['0.5rem', '0.75rem']
                        },
                        spacing: {
                            '1.25': '0.3125rem',
                            '4.5': '1.125rem'
                        }
                    }
                }
            }

            /* Handlebars.registerHelper('ifNotFirstIndex', function(index, options) {
                if (index !== 0) {
                    return options.fn(this);
                } else {
                    return options.inverse(this);
                }
            }); */
        </script>

        <script defer>
            const stripe = Stripe("pk_test_51IOOwOE1ozL6C4r7Wo7PjgNrV8qpU0HPg3d6B3tcHXXOxqzMaC1ckvRam4ocKsjjXqpcCB3Vdz4WsB1BoSSeqy0400luYqQTaq");

            async function initializeStripe(priceId) {

                /* console.log('-- priceId:', priceId);

                const fetchClientSecret = async () => {
                    const response = await fetch("/api/v1/stripe/checkout/sessions/create", {
                        method: "POST",
                    });
                    const {
                        clientSecret
                    } = await response.json();
                    return clientSecret;
                };

                const checkout = await stripe.initEmbeddedCheckout({
                    fetchClientSecret,
                });

                checkout.mount('#checkout'); */
            }
        </script>

        <script>
            function waitNextTick() {
                return new Promise(resolve => {
                    setTimeout(resolve, 0);
                });
            }

            let modalEl;

            function initModal() {
                const bodyEl = document.body;
                const bodyElStyle = window.getComputedStyle(bodyEl);
                const bodyPaddingTop = parseInt(bodyElStyle.paddingTop);
                const bodyPaddingRight = parseInt(bodyElStyle.paddingRight);
                const bodyPaddingBottom = parseInt(bodyElStyle.paddingBottom);
                const bodyPaddingLeft = parseInt(bodyElStyle.paddingLeft);

                const headerEl = document.querySelector('header');
                const headerElRect = headerEl.getBoundingClientRect();
                const headerElBottom = headerElRect.bottom;

                modalEl = document.getElementById('modal');

                modalEl.style.top = `${headerElBottom}px`;
                modalEl.style.right = `${bodyPaddingRight}px`;
                modalEl.style.bottom = `${bodyPaddingBottom}px`;
                modalEl.style.left = `${bodyPaddingLeft}px`;
                // modalEl.style.opacity = '0';
            }

            async function openModal() {
                modalEl.classList.remove('hidden');
                const modalContentHeight = modalEl.scrollHeight;
                modalEl.style.height = '0';
                await waitNextTick();
                modalEl.animate([{
                    height: '0'
                }, {
                    height: `${modalContentHeight}px`
                }], {
                    duration: 400,
                    fill: 'forwards',
                    easing: 'ease-out'
                });
            }

            function closeModal() {
                const modalContentHeight = modalEl.scrollHeight;

                modalEl.animate([{
                    height: `${modalContentHeight}px`,
                }, {
                    height: '0'
                }], {
                    duration: 300,
                    fill: 'forwards',
                    easing: 'ease-in'
                }).onfinish = () => {
                    modalEl.classList.add('hidden');
                };
            }

            window.addEventListener('DOMContentLoaded', initModal);
            window.addEventListener('resize', initModal);

            window.addEventListener('DOMContentLoaded', () => {
                setTimeout(openModal, 1000);
                setTimeout(closeModal, 2000);
            });
        </script>

        <style>
            #products::-webkit-scrollbar {
                height: 0.25rem;
            }

            #products::-webkit-scrollbar-thumb,
            #products::-webkit-scrollbar-track {
                border-radius: 0;
            }

            #products::-webkit-scrollbar-thumb {
                background: rgb(161 161 170);
                ;
            }

            #products::-webkit-scrollbar-track {
                background: rgb(63 63 70);
            }
        </style>
    </head>
    <body class="flex flex-col flex-grow gap-y-4 sm:gap-y-6 md:gap-y-8 lg:gap-y-10 bg-zinc-950 p-4 sm:p-6 md:p-8 lg:p-10 h-full min-h-screen font-['Inter'] text-zinc-200 transition-opacity duration-200 ease-linear overscroll-none"
          hx-ext="client-side-templates">
        {# Header #}
        <header class="top-4 sm:top-6 md:top-8 lg:top-10 z-[5] sticky flex items-end justify-between bg-zinc-950 pr-5 pt-3 pb-5 border-b md:border-b-2 border-zinc-700">
            <p class="text-xs text-zinc-300">
                <!-- py-1.5 px-3.5 bg-zinc-900 border border-zinc-800 -->
                Stripe Checkout - Example with HTMX + hyperscript
            </p>
            <div class="flex justify-center items-center">
                <svg class="text-zinc-300"
                     role="img"
                     viewBox="0 0 24 24"
                     width="36"
                     height="36"
                     xmlns="http://www.w3.org/2000/svg"
                     fill="currentColor">
                    <title>Apostrophe</title>
                    <path d="M15.674 0c-.795.001-1.794.095-3.167.313l-4.6.729c-3.138.497-4.224 1.003-5.274 1.798a6.485 6.485 0 00-2.24 3.082c-.43 1.245-.577 2.434-.08 5.571l.729 4.6c.497 3.138 1.003 4.22 1.798 5.273a6.485 6.485 0 003.082 2.24c1.245.431 2.434.578 5.571.081l4.6-.729c3.138-.497 4.22-1.003 5.273-1.799a6.477 6.477 0 002.24-3.081c.431-1.245.578-2.434.082-5.571l-.73-4.6c-.497-3.138-1.003-4.224-1.799-5.274a6.477 6.477 0 00-3.081-2.24C17.378.152 16.695 0 15.674 0zm-5.319 4.566a.52.52 0 01.003 0 .52.52 0 01.52.444l.77 4.865a.52.52 0 01-.435.6l-4.859.77a.52.52 0 01-.602-.436l-.77-4.866a.52.52 0 01.435-.6l4.86-.77a.52.52 0 01.078-.007zM9.92 5.692l-3.823.605.612 3.83 3.813-.605zm6.504 2.91a3.274 3.274 0 01.497 6.513 3.258 3.258 0 01-3.713-2.726 3.274 3.274 0 013.216-3.787zm-.054 1.058a2.226 2.226 0 10.388 4.42 2.208 2.208 0 001.818-2.541 2.226 2.226 0 00-2.206-1.879zm-6.45 3a.52.52 0 01.424.208l3.824 4.964a.52.52 0 01-.333.839l-5.932.937a.52.52 0 01-.576-.695l2.108-5.901a.52.52 0 01.486-.352zm.18 1.611L8.61 18.438l4.186-.664z">
                    </path>
                </svg>
            </div>
        </header>
        <!-- <button hx-post="/api/v1/stripe/checkout/sessions/create" hx-vals="{ line_items: [{ price: '{{ stripePriceObject.id }}', quantity: 1 }], success_url: '{{ global.locationHref }}', cancel_url: '{{ global.locationHref }}' }" hx-target="body" hx-swap="beforeend" handlebars-template="modal">
                                {{ title }}
                            </button> -->
        <div hx-ext="loading-states">
            <div id="products"
                 hx-get="/api/v1/stripe-products/product"
                 hx-trigger="load"
                 handlebars-template="products-template"
                 class="snap-x snap-mandatory pb-3 md:pb-5 overflow-x-auto grid grid-flow-col auto-cols-[100%] sm:auto-cols-[calc(50%-1rem)] lg:auto-cols-[minmax(calc((100%/3)-(4rem/3)),100%)] gap-x-8 transition-opacity duration-300 ease-linear opacity-0"
                 data-loading-class="opacity-0">
                <!-- lg:auto-cols-fr -->
                <!-- flex flex-nowrap justify-start sm:justify-center -->
                <!-- grid sm:auto-cols-[50%] md:auto-cols-[33.333%] -->
                {% raw %}
                    <template id="products-template">
                        <!-- TODO only list services -->
                        {{#results}}
                        <div class="group snap-start cursor-pointer">
                            <!-- flex flex-shrink-0 w-full sm:w-1/2 md:w-1/3 -->
                            <div class="flex flex-col justify-between items-start p-8 bg-zinc-900 border-t md:border-t-2 border-zinc-800 group-hover:bg-zinc-800 group-hover:border-zinc-700 transition-background duration-150 ease-linear">
                                <div class="flex flex-col">
                                    <img class="w-32 aspect-square object-center object-cover"
                                         src="{{ stripeProductObject.images }}">
                                    <h3 class="group-hover:text-slate-200 text-zinc-300 mt-12 text-left text-xl transition-all underline underline-offset-4 duration-100 ease-linear decoration-transparent hover:decoration-zinc-200">
                                        {{ stripeProductObject.name }}
                                    </h3>
                                    <p class="mt-6 group-hover:text-slate-200 text-zinc-300">
                                        {{ stripeProductObject.description }}
                                    </p>
                                    <p class="group-hover:text-slate-200 text-zinc-300 mt-4">
                                        <span>{{ stripePriceObject.unit_amount }}</span>
                                        <span class="uppercase">{{ stripePriceObject.currency }}</span>
                                    </p>
                                </div>
                                <button _="on click call initializeStripe('{{ stripePriceObject.id }}')"
                                        class="mt-12 py-2 px-4 bg-yellow-400 hover:bg-zinc-200 text-zinc-950 transition-all duration-150 ease-linear">
                                    Subscribe <!-- if product then "Buy" if service "Subscribe" -->
                                </button>
                            </div>
                        </div>
                    {{/results}}
                </template>
            {% endraw %}
        </div>
    </div>

    <div id="modal" class="fixed z-10 inset-0 bg-zinc-700 hidden">
    </div>

    <!-- <template id="modal">
        <div _="on closeModal add .hidden then wait for animationend then remove me" class="fixed inset-0 z-5 bg-amber-400">
            <div class="modal-underlay" _="on click trigger closeModal">
            </div>
            <div class="modal-content">
                <h1>
                    Modal Dialog
                </h1>
            </div>
            <button _="on click trigger closeModal">
                Close
            </button>
        </div>
    </template> -->

</body>
</html>
